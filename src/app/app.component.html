<div class="wrapper" [ngClass]="{'darkMode': gameStateService.isDarkMode}">
  <div class="mainContainer">
    <div class="top-line">
      <span class="gameTitle">
        Immortality Idle 2
        <span class="versionNumber" (click)="changelogClicked()">{{gameStateService.isExperimental ? "Experimental" : "v" + applicationVersion}}</span>
      </span>
      <mat-icon matTooltip="Confused? Click here for a tutorial." class="iconButton" (click)="tutorialClicked()" aria-label="Tutorial" aria-hidden="false">
        help
      </mat-icon>
      <mat-icon matTooltip="Statistics!" class="iconButton" (click)="statisticsClicked()">
        format_list_numbered_rtl
      </mat-icon>
      <span>
        <mat-icon matTooltip="A store that sells special manuals for aspiring immortals." class="iconButton" aria-label="Store" aria-hidden="false"
          [ngClass]="{highlighted: storeService.isManualAvailable()}"
          (click)="storeClicked()">
          local_library
        </mat-icon>
        <mat-icon matTooltip="Options. Lots of them." class="iconButton" aria-label="Options" aria-hidden="false"
          (click)="storeOptionsClicked()">
          settings
        </mat-icon>
      </span>
      <mat-icon matTooltip="Achievements!" class="iconButton" aria-label="Achievements" aria-hidden="false"
        (click)="achievementsClicked()">
        military_tech
      </mat-icon>
      @if (impossibleTaskService.impossibleTasksUnlocked) {
        <mat-icon matTooltip="Impossible Tasks" class="iconButton" aria-label="Impossible Tasks" aria-hidden="false"
          (click)="impossibleTasksClicked()">
          priority_high
        </mat-icon>
      }
      @if (characterService.characterState.ascensionUnlocked) {
        <span>
          <mat-icon matTooltip="Ascension Techniques." class="iconButton" aria-label="Ascension" aria-hidden="false"
            (click)="ascensionStoreClicked()">
            keyboard_double_arrow_up
          </mat-icon>
        </span>
      }
      <span class="discordLink">
        <a href="https://discord.gg/Na7Qmwy3XK" target="_blank" rel="noopener noreferrer" matTooltip="Have questions? Try the Immortality Idle Discord.">Discord</a>
      </span>
      <span>
        <input type="checkbox" id="lockPanels" (change)="lockPanelsToggle()" [checked]="gameStateService.lockPanels"/>
        <label for="lockPanels">Lock panels in place</label>
      </span>
      <!--
      @if(!gameStateService.lockPanels){
        <span>
          <button (click)="gameStateService.resetPanels()">Reset Panels to Default Locations</button>
        </span>
      }
      -->
      @if(!gameStateService.allPanelsUsed){
        <span>
          <button (click)="gameStateService.addLayoutPanel()">Add New Panel</button>
        </span>
      }
    </div>
    <div class="grid-container">
      <ktd-grid cols="100"
          rowHeight="10"
          [compactType]="compactType"
          [gap]="gridGap"
          compactOnPropsChange="true"
          preventCollision="false"
          [layout]="gameStateService.layout"
          [scrollableParent]="document"
          (layoutUpdated)="onLayoutUpdated($event)">
          @for (panelLayout of gameStateService.layout; track panelLayout.id){
            <ktd-grid-item [draggable]="!gameStateService.lockPanels" [resizable]="!gameStateService.lockPanels" dragStartThreshold="0" [id]="getPanel(panelLayout).id">
              <div class="panel">
                <div ktdGridDragHandle [ngClass]="{'grabCursor': !gameStateService.lockPanels}" class="panelHeader">
                  <mat-icon>
                    {{getPanel(panelLayout).icon}}
                  </mat-icon>
                  <span>{{getPanel(panelLayout).name}}</span>
                  <span class="panelHelp">
                    <mat-icon [matTooltip]="getPanel(panelLayout).panelHelp">
                      help
                    </mat-icon>
                    @if(!gameStateService.allPanelsUsed){
                      <mat-icon class="iconButton" (click)="previousPanelClick($index)">
                        arrow_back
                      </mat-icon>
                      <mat-icon class="iconButton" (click)="nextPanelClick($index)">
                        arrow_forward
                      </mat-icon>
                    }
                    <mat-icon class="iconButton" (click)="closePanelClick($index)">
                      close
                    </mat-icon>
                  </span>
                  </div>
                <div class="grid-item-content">
                  @if (panelLayout.id === 'timePanel'){
                    <app-time-panel class="panelComponent"></app-time-panel>
                  } @else if (panelLayout.id === 'attributesPanel'){
                    <app-attributes-panel class="panelComponent"></app-attributes-panel>
                  } @else if (panelLayout.id === 'healthPanel'){
                    <app-health-panel class="panelComponent"></app-health-panel>
                  } @else if (panelLayout.id === 'activityPanel'){
                    <app-activity-panel class="panelComponent" ></app-activity-panel>
                  } @else if (panelLayout.id === 'battlePanel'){
                    <app-battle-panel class="panelComponent" ></app-battle-panel>
                  } @else if (panelLayout.id === 'equipmentPanel'){
                    <app-equipment-panel class="panelComponent" ></app-equipment-panel>
                  } @else if (panelLayout.id === 'homePanel'){
                    <app-home-panel class="panelComponent" ></app-home-panel>
                  } @else if (panelLayout.id === 'inventoryPanel'){
                    <app-inventory-panel class="panelComponent" ></app-inventory-panel>
                  } @else if (panelLayout.id === 'logPanel'){
                    <app-log-panel class="panelComponent" ></app-log-panel>
                  } @else if (panelLayout.id === 'portalPanel'){
                    <app-portal-panel class="panelComponent" ></app-portal-panel>
                  } @else if (panelLayout.id === 'followersPanel'){
                    <app-followers-panel class="panelComponent"></app-followers-panel>
                  } @else if (panelLayout.id === 'petsPanel'){
                    <app-pets-panel class="panelComponent" ></app-pets-panel>
                  }
                </div>
              </div>
            </ktd-grid-item>
          }
      </ktd-grid>
    </div>
  </div>
</div>
